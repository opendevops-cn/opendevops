<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>集群部署 | OpenDevOps</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content=" Vue驱动的CoDo快速入门文档">
    
    <link rel="preload" href="/assets/css/0.styles.c8e23b86.css" as="style"><link rel="preload" href="/assets/js/app.e9c144ab.js" as="script"><link rel="preload" href="/assets/js/2.7c46101f.js" as="script"><link rel="preload" href="/assets/js/22.9271d7e7.js" as="script"><link rel="prefetch" href="/assets/js/10.ebbbf0a3.js"><link rel="prefetch" href="/assets/js/11.3e67cbc3.js"><link rel="prefetch" href="/assets/js/12.7ba93764.js"><link rel="prefetch" href="/assets/js/13.da5a85e8.js"><link rel="prefetch" href="/assets/js/14.3901f50a.js"><link rel="prefetch" href="/assets/js/15.755c9d7b.js"><link rel="prefetch" href="/assets/js/16.9f6c6ba4.js"><link rel="prefetch" href="/assets/js/17.5f0409e1.js"><link rel="prefetch" href="/assets/js/18.ff6e90fb.js"><link rel="prefetch" href="/assets/js/19.d4c7a73d.js"><link rel="prefetch" href="/assets/js/20.457b8a0d.js"><link rel="prefetch" href="/assets/js/21.f132940f.js"><link rel="prefetch" href="/assets/js/23.a0a60b68.js"><link rel="prefetch" href="/assets/js/24.928bd2dd.js"><link rel="prefetch" href="/assets/js/25.e23d438c.js"><link rel="prefetch" href="/assets/js/26.9c61a799.js"><link rel="prefetch" href="/assets/js/3.5c7b1b2d.js"><link rel="prefetch" href="/assets/js/4.c42efd98.js"><link rel="prefetch" href="/assets/js/5.3d5a79e4.js"><link rel="prefetch" href="/assets/js/6.f6831b64.js"><link rel="prefetch" href="/assets/js/7.347713f4.js"><link rel="prefetch" href="/assets/js/8.34375613.js"><link rel="prefetch" href="/assets/js/9.b40e46a0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c8e23b86.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://img.opendevops.cn/logo.png" alt="OpenDevOps" class="logo"> <span class="site-name can-hide">OpenDevOps</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/zh/ad/" class="nav-link">
  招募
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="部署文档" class="dropdown-title"><span class="title">部署文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="部署文档" class="mobile-dropdown-title"><span class="title">部署文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/guide/install/local/" class="nav-link">
  单机部署
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/install/distribute/" class="nav-link">
  分布式部署
</a></li></ul></div></div><div class="nav-item"><a href="/zh/guide/used/" class="nav-link">
  使用文档
</a></div><div class="nav-item"><a href="https://bbs.opendevops.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  论坛
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.opendevops.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://demo.opendevops.cn/login" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Demo
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/opendevops/opendevops" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/opendevops-cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="了解更多" class="dropdown-title"><span class="title">了解更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="了解更多" class="mobile-dropdown-title"><span class="title">了解更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/guide/more/faq/" class="nav-link">
  FAQ
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/more/qgroup/" class="nav-link">
  QQ群
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/more/contributor/" class="nav-link">
  贡献者
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/more/permission/" class="nav-link">
  权限文档
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/more/example/" class="nav-link">
  最佳示例
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/more/update/" class="nav-link">
  如何更新
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/zh/ad/" class="nav-link">
  招募
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="部署文档" class="dropdown-title"><span class="title">部署文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="部署文档" class="mobile-dropdown-title"><span class="title">部署文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/guide/install/local/" class="nav-link">
  单机部署
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/install/distribute/" class="nav-link">
  分布式部署
</a></li></ul></div></div><div class="nav-item"><a href="/zh/guide/used/" class="nav-link">
  使用文档
</a></div><div class="nav-item"><a href="https://bbs.opendevops.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  论坛
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.opendevops.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://demo.opendevops.cn/login" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Demo
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/opendevops/opendevops" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/opendevops-cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="了解更多" class="dropdown-title"><span class="title">了解更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="了解更多" class="mobile-dropdown-title"><span class="title">了解更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/guide/more/faq/" class="nav-link">
  FAQ
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/more/qgroup/" class="nav-link">
  QQ群
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/more/contributor/" class="nav-link">
  贡献者
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/more/permission/" class="nav-link">
  权限文档
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/more/example/" class="nav-link">
  最佳示例
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/more/update/" class="nav-link">
  如何更新
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>它是什么</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/guide/" aria-current="page" class="sidebar-link">OpenDevOps</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>如何安装</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/guide/install/local/" class="sidebar-link">单机部署</a></li><li><a href="/zh/guide/install/distribute/" class="sidebar-link">分布式部署</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>如何使用</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/guide/used/" class="sidebar-link">如何使用</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>中间件部署</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>ETCD</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/guide/plugin/middleware/etcd/simple.html" class="sidebar-link">单机部署</a></li><li><a href="/zh/guide/plugin/middleware/etcd/cluster.html" aria-current="page" class="active sidebar-link">集群部署</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>插件部署</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/guide/plugin/Bind.html" class="sidebar-link">DNS Bind</a></li><li><a href="/zh/guide/plugin/Inception.html" class="sidebar-link">Inception</a></li><li><a href="/zh/guide/plugin/sonarQube.html" class="sidebar-link">sonarQube</a></li><li><a href="/zh/guide/plugin/SQLAdvisor.html" class="sidebar-link">SQLAdvisor</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其他相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/guide/more/faq/" class="sidebar-link">FAQ</a></li><li><a href="/zh/guide/more/qgroup/" class="sidebar-link">加入交流群</a></li><li><a href="/zh/guide/more/contributor/" class="sidebar-link">贡献者</a></li><li><a href="/zh/guide/more/permission/" class="sidebar-link">权限文档</a></li><li><a href="/zh/guide/more/example/" class="sidebar-link">最佳实践</a></li><li><a href="/zh/guide/more/update/" class="sidebar-link">如何更新</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="集群部署"><a href="#集群部署" class="header-anchor">#</a> 集群部署</h1> <ul><li><code>作者：青牛踏雪御苍穹（CoDo老王)</code></li> <li>部署 ETCD 集群（自签证书）</li></ul> <h3 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h3> <p>操作系统：Ubuntu 18.04.3 LTS （本地环境） 集群部署（自签证书）</p> <p>自行打通服务器之间的SSH免密，或者自己输入密码来完成复制操作。</p> <h3 id="配置环境变量"><a href="#配置环境变量" class="header-anchor">#</a> 配置环境变量</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">ETCD_DIR</span><span class="token operator">=</span><span class="token string">'${ETCD_DIR}'</span>
mkddir <span class="token variable">${ETCD_DIR}</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${ETCD_DIR}</span>/environment.sh <span class="token operator">&lt;&lt;</span><span class="token string">EOF
#!/usr/bin/bash
# etcd 版本
export ETCD_VERSION='3.4.14'

# 集群节点
export ETCD0='192.168.1.220'
export ETCD1='192.168.1.221'
export ETCD2='192.168.1.222'

# ETCD集群各机器 IP 数组
export NODE_IPS=(<span class="token variable">${ETCD0}</span> <span class="token variable">${ETCD1}</span> <span class="token variable">${ETCD2}</span>)

# 集群各 IP 对应的主机名数组
export NODE_NAMES=(etcd-0 etcd-1 etcd-2)

# etcd 集群服务地址列表
export ETCD_ENDPOINTS=&quot;https://<span class="token variable">${ETCD0}</span>:2379,https://<span class="token variable">${ETCD1}</span>:2379,https://<span class="token variable">${ETCD2}</span>:2379&quot;

# etcd 集群间通信的 IP 和端口
export ETCD_NODES=&quot;etcd-0=https://<span class="token variable">${ETCD0}</span>:2380,etcd-1=https://<span class="token variable">${ETCD1}</span>:2380,etcd-2=https://<span class="token variable">${ETCD2}</span>:2380&quot;

# etcd 目录
export ETCD_DIR=&quot;/data/etcd&quot;

# etcd 数据目录
export ETCD_DATA_DIR=&quot;/data/etcd/data&quot;

# etcd WAL 目录，建议是 SSD 磁盘分区，或者和 ETCD_DATA_DIR 不同的磁盘分区
export ETCD_WAL_DIR=&quot;/data/etcd/wal&quot;

# etcd 自签证书存放目录
export ETCD_CA_DIR='/data/etcd/ca'

# etcd 各个节点证书存放目录
export ETCD_ETC_DIR='/etc/etcd/cert'
EOF</span>
<span class="token function">chmod</span> +x environment.sh
<span class="token comment"># 创建存放数据、证书、WAl目录</span>
<span class="token function">mkdir</span> <span class="token variable">${ETCD_DATA_DIR}</span> <span class="token variable">${ETCD_CA_DIR}</span> <span class="token variable">${ETCD_WAL_DIR}</span>
</code></pre></div><p>配置本地hosts</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 配置本地host</span>
<span class="token builtin class-name">source</span> <span class="token variable">${ETCD_DIR}</span>/environment.sh
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/hosts <span class="token operator">&lt;&lt;</span><span class="token string">EOF
<span class="token variable">${ETCD0}</span> etcd-1
<span class="token variable">${ETCD1}</span> etcd-2
<span class="token variable">${ETCD2}</span> etcd-3
EOF</span>
</code></pre></div><h3 id="下载和分发-etcd-二进制文件"><a href="#下载和分发-etcd-二进制文件" class="header-anchor">#</a> 下载和分发 etcd 二进制文件</h3> <p><a href="https://github.com/coreos/etcd/releases" target="_blank" rel="noopener noreferrer">release<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 查找自己需要的版本。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">source</span> <span class="token variable">${ETCD_DIR}</span>/environment.sh
<span class="token builtin class-name">cd</span> <span class="token variable">${ETCD_DIR}</span>
<span class="token function">wget</span> https://github.com/coreos/etcd/releases/download/v<span class="token variable">${ETCD_VERSION}</span>/etcd-v<span class="token variable">${ETCD_VERSION}</span>-linux-amd64.tar.gz
<span class="token function">tar</span> xvf etcd-v<span class="token variable">${ETCD_VERSION}</span>-linux-amd64.tar.gz
</code></pre></div><h3 id="分发二进制文件到各个主机"><a href="#分发二进制文件到各个主机" class="header-anchor">#</a> 分发二进制文件到各个主机</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token variable">${ETCD_DIR}</span>
<span class="token builtin class-name">source</span> <span class="token variable">${ETCD_DIR}</span>/environment.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">node_ip</span> <span class="token keyword">in</span> <span class="token variable">${NODE_IPS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
  <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;&gt;&gt;&gt; <span class="token variable">${node_ip}</span>&quot;</span>
    <span class="token function">scp</span> -r /data/etcd/etcd-v<span class="token variable">${ETCD_VERSION}</span>-linux-amd64/etcd* root@<span class="token variable">${node_ip}</span>:/usr/local/bin/
    <span class="token function">ssh</span> root@<span class="token variable">${node_ip}</span> <span class="token string">&quot;chmod +x /usr/local/bin/etcd*&quot;</span>
<span class="token keyword">done</span>
<span class="token comment"># 输出结果</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.220
etcd                                                                                                  <span class="token number">100</span>%   23MB  <span class="token number">51</span>.1MB/s   00:00
etcdctl                                                                                               <span class="token number">100</span>%   17MB  <span class="token number">44</span>.5MB/s   00:00
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.221
etcd                                                                                                  <span class="token number">100</span>%   23MB  <span class="token number">39</span>.1MB/s   00:00
etcdctl                                                                                               <span class="token number">100</span>%   17MB  <span class="token number">34</span>.4MB/s   00:00
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.222
etcd                                                                                                  <span class="token number">100</span>%   23MB  <span class="token number">52</span>.0MB/s   00:00
etcdctl                                                                                               <span class="token number">100</span>%   17MB  <span class="token number">45</span>.8MB/s   00:00  
</code></pre></div><h3 id="安装-cfssl-工具集"><a href="#安装-cfssl-工具集" class="header-anchor">#</a> 安装 cfssl 工具集</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 安装cfssl</span>
<span class="token builtin class-name">cd</span> <span class="token variable">${ETCD_DIR}</span>
<span class="token function">wget</span> https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssl_1.4.1_linux_amd64
<span class="token function">mv</span> cfssl_1.4.1_linux_amd64 /usr/local/bin/cfssl

<span class="token comment"># cfssljson</span>
<span class="token function">wget</span> https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssljson_1.4.1_linux_amd64
<span class="token function">mv</span> cfssljson_1.4.1_linux_amd64 /usr/local/bin/cfssljson

<span class="token comment"># cfssl-certinfo</span>
<span class="token function">wget</span> https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssl-certinfo_1.4.1_linux_amd64
<span class="token function">mv</span> cfssl-certinfo_1.4.1_linux_amd64 /usr/local/bin/cfssl-certinfo

<span class="token comment"># 添加执行权限</span>
<span class="token function">chmod</span> +x /usr/local/bin/cfssl*
</code></pre></div><h3 id="创建证书"><a href="#创建证书" class="header-anchor">#</a> 创建证书</h3> <p>CA 配置文件用于配置根证书的使用场景 (profile) 和具体参数 (usage，过期时间、服务端认证、客户端认证、加密等)：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token variable">${ETCD_CA_DIR}</span> 
<span class="token function">cat</span> <span class="token operator">&gt;</span> ca-config.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  &quot;signing&quot;: {
    &quot;default&quot;: {
      &quot;expiry&quot;: &quot;87600h&quot;
    },
    &quot;profiles&quot;: {
      &quot;etcd-cluster&quot;: {
        &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ],
        &quot;expiry&quot;: &quot;876000h&quot;
      }
    }
  }
}
EOF</span>
</code></pre></div><p>创建证书签名请求文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> ca-csr.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  &quot;CN&quot;: &quot;kubernetes-ca&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;etcd&quot;,
      &quot;OU&quot;: &quot;opsnull&quot;
    }
  ],
  &quot;ca&quot;: {
    &quot;expiry&quot;: &quot;876000h&quot;
 }
}
EOF</span>
</code></pre></div><ul><li><code>signing</code>：表示该证书可用于签名其它证书（生成的 <code>ca.pem</code> 证书中 <code>CA=TRUE</code>）；</li> <li><code>server auth</code>：表示 client 可以用该该证书对 server 提供的证书进行验证；</li> <li><code>client auth</code>：表示 server 可以用该该证书对 client 提供的证书进行验证；</li> <li><code>&quot;expiry&quot;: &quot;876000h&quot;</code>：证书有效期设置为 100 年；</li></ul> <h3 id="创建证书签名请求文件"><a href="#创建证书签名请求文件" class="header-anchor">#</a> 创建证书签名请求文件</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> ca-csr.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  &quot;CN&quot;: &quot;kubernetes-ca&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;etcd&quot;,
      &quot;OU&quot;: &quot;opsnull&quot;
    }
  ],
  &quot;ca&quot;: {
    &quot;expiry&quot;: &quot;876000h&quot;
 }
}
EOF</span>
</code></pre></div><ul><li><code>CN：Common Name</code>：etcd 从证书中提取该字段作为请求的<strong>用户名 (User Name)</strong>，浏览器使用该字段验证网站是否合法；</li> <li><code>O：Organization</code>：etcd 从证书中提取该字段作为请求用户所属的<strong>组 (Group)</strong>； kube-apiserver 将提取的 <code>User、Group</code> 作为 <code>RBAC</code> 授权的用户标识；</li></ul> <h3 id="生成证书文件和私钥"><a href="#生成证书文件和私钥" class="header-anchor">#</a> 生成证书文件和私钥</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token variable">${ETCD_CA_DIR}</span> 
cfssl gencert -initca ca-csr.json <span class="token operator">|</span> cfssljson -bare ca
输出结果：
<span class="token number">2020</span>/12/17 09:54:25 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating a new CA key and certificate from CSR
<span class="token number">2020</span>/12/17 09:54:25 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/12/17 09:54:25 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/12/17 09:54:25 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/12/17 09:54:26 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/12/17 09:54:26 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">437386317969465523284385845194090172491501571515</span>
$ <span class="token function">ls</span> ca*
<span class="token comment"># 输出结果：</span>
ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem
</code></pre></div><h3 id="分发证书文件"><a href="#分发证书文件" class="header-anchor">#</a> 分发证书文件</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">source</span> <span class="token variable">${ETCD_DIR}</span>/environment.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">node_ip</span> <span class="token keyword">in</span> <span class="token variable">${NODE_IPS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
  <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;&gt;&gt;&gt; <span class="token variable">${node_ip}</span>&quot;</span>
    <span class="token function">ssh</span> root@<span class="token variable">${node_ip}</span> <span class="token string">&quot;mkdir -p <span class="token variable">${ETCD_ETC_DIR}</span>&quot;</span>
    <span class="token function">scp</span> ca*.pem ca-config.json root@<span class="token variable">${node_ip}</span><span class="token builtin class-name">:</span><span class="token variable">${ETCD_ETC_DIR}</span>
<span class="token keyword">done</span>
<span class="token comment"># 输出结果：</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.220
ca-key.pem                                                                                            <span class="token number">100</span>% <span class="token number">1679</span>     <span class="token number">1</span>.2MB/s   00:00
ca.pem                                                                                                <span class="token number">100</span>% <span class="token number">1326</span>     <span class="token number">1</span>.2MB/s   00:00
ca-config.json                                                                                        <span class="token number">100</span>%  <span class="token number">293</span>   <span class="token number">221</span>.9KB/s   00:00
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.221
ca-key.pem                                                                                            <span class="token number">100</span>% <span class="token number">1679</span>     <span class="token number">1</span>.1MB/s   00:00
ca.pem                                                                                                <span class="token number">100</span>% <span class="token number">1326</span>     <span class="token number">1</span>.2MB/s   00:00
ca-config.json                                                                                        <span class="token number">100</span>%  <span class="token number">293</span>   <span class="token number">180</span>.2KB/s   00:00
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.222
ca-key.pem                                                                                            <span class="token number">100</span>% <span class="token number">1679</span>   <span class="token number">973</span>.5KB/s   00:00
ca.pem                                                                                                <span class="token number">100</span>% <span class="token number">1326</span>   <span class="token number">972</span>.0KB/s   00:00
ca-config.json  
</code></pre></div><p>注意：</p> <ol><li>不同证书 csr 文件的 CN、C、ST、L、O、OU 组合必须不同，否则可能出现 PEER'S CERTIFICATE HAS AN INVALID SIGNATURE 错误；</li> <li>后续创建证书的 csr 文件时，CN 都不相同（C、ST、L、O、OU 相同），以达到区分的目的；</li></ol> <p>etcd-csr证书签名</p> <ul><li><code>hosts</code>：指定授权使用该证书的 etcd 节点 IP 列表，<strong>需要将 etcd 集群所有节点 IP 都列在其中</strong></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token variable">${ETCD_CA_DIR}</span> 
<span class="token function">cat</span> <span class="token operator">&gt;</span> /data/etcd/ca/etcd-csr.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  &quot;CN&quot;: &quot;etcd&quot;,
  &quot;hosts&quot;: [
    &quot;127.0.0.1&quot;,
    &quot;<span class="token variable">${ETCD0}</span>&quot;,
    &quot;<span class="token variable">${ETCD1}</span>&quot;,
    &quot;<span class="token variable">${ETCD2}</span>&quot;
  ],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;etcd&quot;,
      &quot;OU&quot;: &quot;opsnull&quot;
    }
  ]
}
EOF</span>
</code></pre></div><p>生成证书和私钥：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cfssl gencert -ca<span class="token operator">=</span><span class="token variable">${ETCD_CA_DIR}</span>/ca.pem <span class="token punctuation">\</span>
    -ca-key<span class="token operator">=</span><span class="token variable">${ETCD_CA_DIR}</span>/ca-key.pem <span class="token punctuation">\</span>
    -config<span class="token operator">=</span><span class="token variable">${ETCD_CA_DIR}</span>/ca-config.json <span class="token punctuation">\</span>
    -profile<span class="token operator">=</span>etcd-cluster <span class="token variable">${ETCD_CA_DIR}</span>/etcd-csr.json <span class="token operator">|</span> cfssljson -bare etcd
<span class="token comment"># 输出结果：</span>
<span class="token number">2020</span>/12/17 <span class="token number">10</span>:03:52 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/12/17 <span class="token number">10</span>:03:52 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/12/17 <span class="token number">10</span>:03:52 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/12/17 <span class="token number">10</span>:03:53 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/12/17 <span class="token number">10</span>:03:53 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">290666497635689555552442344139619956527112356386</span>    
</code></pre></div><h3 id="分发证书"><a href="#分发证书" class="header-anchor">#</a> 分发证书</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token variable">${ETCD_CA_DIR}</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">node_ip</span> <span class="token keyword">in</span> <span class="token variable">${NODE_IPS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
  <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;&gt;&gt;&gt; <span class="token variable">${node_ip}</span>&quot;</span>
    <span class="token function">scp</span> etcd*.pem root@<span class="token variable">${node_ip}</span><span class="token builtin class-name">:</span><span class="token variable">${ETCD_ETC_DIR}</span>
<span class="token keyword">done</span>
<span class="token comment"># 输出结果</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.220
etcd-key.pem                                                                                          <span class="token number">100</span>% <span class="token number">1679</span>   <span class="token number">279</span>.6KB/s   00:00
etcd.pem                                                                                              <span class="token number">100</span>% <span class="token number">1448</span>     <span class="token number">1</span>.3MB/s   00:00
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.221
etcd-key.pem                                                                                          <span class="token number">100</span>% <span class="token number">1679</span>   <span class="token number">763</span>.6KB/s   00:00
etcd.pem                                                                                              <span class="token number">100</span>% <span class="token number">1448</span>     <span class="token number">1</span>.0MB/s   00:00
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.222
etcd-key.pem                                                                                          <span class="token number">100</span>% <span class="token number">1679</span>     <span class="token number">1</span>.0MB/s   00:00
etcd.pem
</code></pre></div><h3 id="创建-etcd-的-systemd-unit-模板文件"><a href="#创建-etcd-的-systemd-unit-模板文件" class="header-anchor">#</a> 创建 etcd 的 systemd unit 模板文件</h3> <p>模板不需要做任何改动，所有需要替换的地方后续都会替换掉：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token variable">${ETCD_DIR}</span>
<span class="token builtin class-name">source</span> <span class="token variable">${ETCD_DIR}</span>/environment.sh
<span class="token function">cat</span> <span class="token operator">&gt;</span> etcd.service.template <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target
Documentation=https://github.com/coreos

[Service]
Type=notify
WorkingDirectory=<span class="token variable">${ETCD_DATA_DIR}</span>
ExecStart=/usr/local/bin/etcd <span class="token entity" title="\\">\\</span>
  --data-dir=<span class="token variable">${ETCD_DATA_DIR}</span> <span class="token entity" title="\\">\\</span>
  --wal-dir=<span class="token variable">${ETCD_WAL_DIR}</span> <span class="token entity" title="\\">\\</span>
  --name=##NODE_NAME## <span class="token entity" title="\\">\\</span>
  --cert-file=<span class="token variable">${ETCD_ETC_DIR}</span>/etcd.pem <span class="token entity" title="\\">\\</span>
  --key-file=<span class="token variable">${ETCD_ETC_DIR}</span>/etcd-key.pem <span class="token entity" title="\\">\\</span>
  --trusted-ca-file=<span class="token variable">${ETCD_ETC_DIR}</span>/ca.pem <span class="token entity" title="\\">\\</span>
  --peer-cert-file=<span class="token variable">${ETCD_ETC_DIR}</span>/etcd.pem <span class="token entity" title="\\">\\</span>
  --peer-key-file=<span class="token variable">${ETCD_ETC_DIR}</span>/etcd-key.pem <span class="token entity" title="\\">\\</span>
  --peer-trusted-ca-file=<span class="token variable">${ETCD_ETC_DIR}</span>/ca.pem <span class="token entity" title="\\">\\</span>
  --peer-client-cert-auth <span class="token entity" title="\\">\\</span>
  --client-cert-auth <span class="token entity" title="\\">\\</span>
  --listen-peer-urls=https://##NODE_IP##:2380 <span class="token entity" title="\\">\\</span>
  --initial-advertise-peer-urls=https://##NODE_IP##:2380 <span class="token entity" title="\\">\\</span>
  --listen-client-urls=https://##NODE_IP##:2379,http://127.0.0.1:2379 <span class="token entity" title="\\">\\</span>
  --advertise-client-urls=https://##NODE_IP##:2379 <span class="token entity" title="\\">\\</span>
  --initial-cluster-token=etcd-cluster-0 <span class="token entity" title="\\">\\</span>
  --initial-cluster=<span class="token variable">${ETCD_NODES}</span> <span class="token entity" title="\\">\\</span>
  --initial-cluster-state=new <span class="token entity" title="\\">\\</span>
  --auto-compaction-mode=periodic <span class="token entity" title="\\">\\</span>
  --auto-compaction-retention=1 <span class="token entity" title="\\">\\</span>
  --max-request-bytes=33554432 <span class="token entity" title="\\">\\</span>
  --quota-backend-bytes=6442450944 <span class="token entity" title="\\">\\</span>
  --heartbeat-interval=250 <span class="token entity" title="\\">\\</span>
  --election-timeout=2000
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre></div><p>参数说明：</p> <ul><li><code>WorkingDirectory</code>、<code>--data-dir</code>：指定工作目录和数据目录为 <code>${ETCD_DATA_DIR}</code>，需在启动服务前创建这个目录；</li> <li><code>--wal-dir</code>：指定 wal 目录，为了提高性能，一般使用 SSD 或者和 <code>--data-dir</code> 不同的磁盘；</li> <li><code>--name</code>：指定节点名称，当 <code>--initial-cluster-state</code> 值为 new 时，<code>--name</code> 的参数值必须位于 <code>--initial-cluster</code> 列表中；</li> <li><code>--cert-file、--key-file</code>：etcd server 与 client 通信时使用的证书和私钥；</li> <li><code>--trusted-ca-file</code>：签名 client 证书的 CA 证书，用于验证 client 证书；</li> <li><code>--peer-cert-file</code>、<code>--peer-key-file</code>：etcd 与 peer 通信使用的证书和私钥；</li> <li><code>--peer-trusted-ca-file</code>：签名 peer 证书的 CA 证书，用于验证 peer 证书；</li></ul> <h3 id="创建和分发-etcd-systemd-unit-文件"><a href="#创建和分发-etcd-systemd-unit-文件" class="header-anchor">#</a> 创建和分发 etcd systemd unit 文件</h3> <p>替换模板文件中的变量，为各节点创建 systemd unit 文件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 生成</span>
<span class="token builtin class-name">source</span> <span class="token variable">${ETCD_DIR}</span>/environment.sh
<span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">))</span></span>
  <span class="token keyword">do</span>
    <span class="token function">sed</span> -e <span class="token string">&quot;s/##NODE_NAME##/<span class="token variable">${NODE_NAMES<span class="token punctuation">[</span>i<span class="token punctuation">]</span>}</span>/&quot;</span> -e <span class="token string">&quot;s/##NODE_IP##/<span class="token variable">${NODE_IPS<span class="token punctuation">[</span>i<span class="token punctuation">]</span>}</span>/&quot;</span> etcd.service.template <span class="token operator">&gt;</span> etcd-<span class="token variable">${NODE_IPS<span class="token punctuation">[</span>i<span class="token punctuation">]</span>}</span>.service 
<span class="token keyword">done</span>
<span class="token comment"># 验证</span>
<span class="token function">ls</span> *.service
<span class="token comment"># 输出结果：</span>
etcd-192.168.1.220.service  etcd-192.168.1.221.service  etcd-192.168.1.222.service
</code></pre></div><ul><li>NODE_NAMES 和 NODE_IPS 为相同长度的 bash 数组，分别为节点名称和对应的 IP；</li></ul> <p>分发生成的 systemd unit 文件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">source</span> <span class="token variable">${ETCD_DIR}</span>/environment.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">node_ip</span> <span class="token keyword">in</span> <span class="token variable">${NODE_IPS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
  <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;&gt;&gt;&gt; <span class="token variable">${node_ip}</span>&quot;</span>
    <span class="token function">scp</span> etcd-<span class="token variable">${node_ip}</span>.service root@<span class="token variable">${node_ip}</span>:/etc/systemd/system/etcd.service
<span class="token keyword">done</span>
</code></pre></div><h3 id="启动服务测试"><a href="#启动服务测试" class="header-anchor">#</a> 启动服务测试</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">source</span> <span class="token variable">${ETCD_DIR}</span>/environment.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">node_ip</span> <span class="token keyword">in</span> <span class="token variable">${NODE_IPS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
  <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;&gt;&gt;&gt; <span class="token variable">${node_ip}</span>&quot;</span>
    <span class="token function">ssh</span> root@<span class="token variable">${node_ip}</span> <span class="token string">&quot;mkdir -p <span class="token variable">${ETCD_DATA_DIR}</span> <span class="token variable">${ETCD_WAL_DIR}</span>&quot;</span>
    <span class="token function">ssh</span> root@<span class="token variable">${node_ip}</span> <span class="token string">&quot;systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl restart etcd &quot;</span> <span class="token operator">&amp;</span>
<span class="token keyword">done</span>
<span class="token comment"># 输出结果：</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.220
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token number">26642</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.221
<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token number">26729</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.222
<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token number">26840</span>
</code></pre></div><ul><li>命令首先创建 etcd 数据目录和工作目录</li> <li>etcd 进程首次启动时会等待其它节点的 etcd 加入集群，命令 <code>systemctl start etcd</code> 会卡住一段时间，为正常现象</li></ul> <h3 id="检查启动结果"><a href="#检查启动结果" class="header-anchor">#</a> 检查启动结果</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">source</span> <span class="token variable">${ETCD_DIR}</span>/environment.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">node_ip</span> <span class="token keyword">in</span> <span class="token variable">${NODE_IPS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
  <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;&gt;&gt;&gt; <span class="token variable">${node_ip}</span>&quot;</span>
    <span class="token function">ssh</span> root@<span class="token variable">${node_ip}</span> <span class="token string">&quot;systemctl status etcd|grep Active&quot;</span>
<span class="token keyword">done</span>

输出结果：
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.220
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Thu <span class="token number">2020</span>-12-17 <span class="token number">10</span>:15:02 UTC<span class="token punctuation">;</span> 31s ago
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.221
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Thu <span class="token number">2020</span>-12-17 <span class="token number">10</span>:15:02 UTC<span class="token punctuation">;</span> 36s ago
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.222
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Thu <span class="token number">2020</span>-12-17 <span class="token number">10</span>:15:02 UTC<span class="token punctuation">;</span> 40s ago  
</code></pre></div><h3 id="验证etcd集群服务状态"><a href="#验证etcd集群服务状态" class="header-anchor">#</a> 验证ETCD集群服务状态</h3> <p>部署完 etcd 集群后，在任一 <code>etcd</code> 节点上执行如下命令，我是etcd-0执行的部署操作。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">source</span> <span class="token variable">${ETCD_DIR}</span>/environment.sh
<span class="token keyword">for</span> <span class="token for-or-select variable">node_ip</span> <span class="token keyword">in</span> <span class="token variable">${NODE_IPS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
  <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;&gt;&gt;&gt; <span class="token variable">${node_ip}</span>&quot;</span>
    /usr/local/bin/etcdctl <span class="token punctuation">\</span>
    --endpoints<span class="token operator">=</span>https://<span class="token variable">${node_ip}</span>:2379 <span class="token punctuation">\</span>
    --cacert<span class="token operator">=</span><span class="token variable">${ETCD_ETC_DIR}</span>/ca.pem <span class="token punctuation">\</span>
    --cert<span class="token operator">=</span><span class="token variable">${ETCD_ETC_DIR}</span>/etcd.pem <span class="token punctuation">\</span>
    --key<span class="token operator">=</span><span class="token variable">${ETCD_ETC_DIR}</span>/etcd-key.pem endpoint health
<span class="token keyword">done</span>
<span class="token comment"># 输出结果：</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.220
https://192.168.1.220:2379 is healthy: successfully committed proposal: took <span class="token operator">=</span> <span class="token number">99</span>.689319ms
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.221
https://192.168.1.221:2379 is healthy: successfully committed proposal: took <span class="token operator">=</span> <span class="token number">47</span>.262066ms
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.222
https://192.168.1.222:2379 is healthy: successfully committed proposal: took <span class="token operator">=</span> <span class="token number">49</span>.330772ms
</code></pre></div><p>ok, etcd集群已经部署完成.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zh/guide/plugin/middleware/etcd/simple.html" class="prev">
        单机部署
      </a></span> <span class="next"><a href="/zh/guide/plugin/Bind.html">
        DNS Bind
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e9c144ab.js" defer></script><script src="/assets/js/2.7c46101f.js" defer></script><script src="/assets/js/22.9271d7e7.js" defer></script>
  </body>
</html>
